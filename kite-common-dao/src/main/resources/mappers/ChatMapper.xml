<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dao.ChatMapper">

    <insert id="createChat" parameterType="Chat" useGeneratedKeys="true" keyColumn="chatId">
        insert into chat(name, memberNum, createDate) values (#{name}, #{memberNum}, #{createDate})
    </insert>

    <select id="getInsertId" resultType="int">
        select LAST_INSERT_ID();
    </select>

    <insert id="addMember">
        insert into member(chatId, userId) values
        <foreach collection="list" item="member" separator=",">
            (#{chatId}, #{member})
        </foreach>
    </insert>

    <select id="getMembers" resultType="Integer" parameterType="Integer">
        select userId from member where chatId = #{chatId}
    </select>

    <insert id="sendMsg">
        insert into message(chatId, userId, message, sendTime) values (#{chatId}, #{from}, #{msg}, now())
    </insert>

    <update id="setOffline" parameterType="Integer">
        update user set lastOnline = now() where userId = ${userId}
    </update>

    <select id="getChatByUser" parameterType="Integer" resultType="pojo.Chat">
        SELECT chat.* FROM chat INNER JOIN member ON
            chat.chatId = member.chatId WHERE member.userId = #{id};
    </select>

    <select id="getUsernameOfOtherMember" resultType="String">
        SELECT user.username from user INNER JOIN member on user.userId = member.userId WHERE member.chatId = #{arg0} AND member.userId != #{arg1}
    </select>

    <select id="getPastChat" resultType="Integer">
        SELECT c.chatId
        FROM chat   AS c
                 JOIN member AS m1  ON c.chatId = m1.chatId
                 JOIN member AS m2  ON c.chatId = m2.chatId
        WHERE c.memberNum = 2
          AND m1.userId     = ${arg0}
          AND m2.userId     = ${arg1}
        LIMIT 1;
    </select>

</mapper>